# Story 0.2: Backend Application Scaffolding

## Status

Draft

## Story

**As a** backend developer,
**I want** a working Express application with TypeScript and basic middleware,
**so that** I can start implementing API endpoints.

## Acceptance Criteria

1. Initialize Express + TypeScript application in /apps/api with proper structure
2. Implement GET /health endpoint returning status, timestamp, version, environment
3. Configure essential middleware: helmet, cors, compression, express.json, request-id
4. Set up centralized error handling with consistent error response format
5. Configure Winston logger with console and file transports with rotation
6. Create nodemon.json for development hot-reload configuration
7. Add npm scripts: dev (tsx), build (tsc), start (node), test (jest)
8. Implement graceful shutdown handling and port configuration from environment

## Tasks / Subtasks

- [ ] Initialize Express + TypeScript application structure (AC: 1)
  - [ ] Create apps/api directory structure with src/, config/, types/ folders
  - [ ] Initialize package.json with proper dependencies and scripts
  - [ ] Configure TypeScript with tsconfig.json extending workspace base config
  - [ ] Install Express, TypeScript, and essential middleware packages
- [ ] Implement health endpoint with proper response format (AC: 2)
  - [ ] Create routes/health.ts with GET /health endpoint
  - [ ] Return status, timestamp, version, environment in JSON response
  - [ ] Add basic endpoint registration in main app.ts
- [ ] Configure essential middleware stack (AC: 3)
  - [ ] Set up helmet for security headers
  - [ ] Configure CORS with appropriate origins
  - [ ] Add compression middleware for response optimization
  - [ ] Configure express.json() for request body parsing
  - [ ] Implement request-id middleware for tracing
- [ ] Set up centralized error handling (AC: 4)
  - [ ] Create error handling middleware with consistent response format
  - [ ] Implement custom error classes for different error types
  - [ ] Add 404 handler for unmatched routes
  - [ ] Configure error logging with appropriate levels
- [ ] Configure Winston logger with proper transports (AC: 5)
  - [ ] Set up console transport for development
  - [ ] Configure file transport with rotation for production
  - [ ] Define log levels and formatting for different environments
  - [ ] Create logger utility module for application-wide use
- [ ] Create nodemon configuration for development (AC: 6)
  - [ ] Configure nodemon.json with TypeScript file watching
  - [ ] Set up environment variable injection
  - [ ] Configure restart patterns and ignore patterns
- [ ] Add comprehensive npm scripts (AC: 7)
  - [ ] Configure dev script using tsx for TypeScript execution
  - [ ] Set up build script using tsc for production builds
  - [ ] Create start script for running compiled JavaScript
  - [ ] Configure test script using Jest
- [ ] Implement graceful shutdown and environment configuration (AC: 8)
  - [ ] Set up SIGTERM and SIGINT signal handlers
  - [ ] Configure port from environment with default fallback
  - [ ] Implement graceful server shutdown with connection draining
  - [ ] Add process exit handlers for cleanup

## Dev Notes

### Previous Story Insights

From Story 0.1, the monorepo structure has been established with:

- pnpm workspace configuration with `apps/*` and `packages/*` structure
- Base TypeScript configuration with workspace path mappings
- Quality toolchain configured (ESLint, Prettier, Jest)
- Node.js v20.17.0 environment specification

### Technology Stack Requirements

[Source: architecture.md#tech-stack]

- **Backend Framework**: Express ^4.19.0 - Current stable (target: 5.x when released)
- **Backend Language**: TypeScript 5.8.3 - Type-safe backend development with code sharing capability
- **Logging**: Winston 3.17 - Application logging with latest stable version
- **Testing**: Jest ^29.7.0 - Current stable API and unit testing
- **Runtime**: Node.js v20.x LTS as specified in .nvmrc

### Repository Structure

[Source: architecture.md#repository-structure]
**Package Organization:**

- `/apps` - Application packages (web, api)
- `/packages` - Shared libraries (ui, shared-types, config)
- `/infrastructure` - Docker configs and deployment scripts

### Development Environment Setup Requirements

[Source: architecture.md#development-workflow-testing-strategy]
The setup script requirements include:

- Node.js version verification (>=20.0.0)
- pnpm installation and verification (>=9.0.0)
- Workspace package linking preferences
- Performance optimizations for air-gapped environments

### File Locations and Structure

Based on monorepo structure, files should be created at:

- Main application: `apps/api/src/app.ts`, `apps/api/src/server.ts`
- Routes: `apps/api/src/routes/health.ts`
- Middleware: `apps/api/src/middleware/`
- Configuration: `apps/api/src/config/`, `apps/api/nodemon.json`
- Package file: `apps/api/package.json`, `apps/api/tsconfig.json`

### API Specifications

[Source: architecture.md#api-specifications]

- RESTful endpoint design with OpenAPI 3.1 specification
- JWT authentication with Redis session management (for future endpoints)
- RBAC middleware with fine-grained permissions (for future endpoints)
- Comprehensive validation using Joi schemas (for future endpoints)

### Backend Architecture

[Source: architecture.md#backend-architecture]

- Layered monolithic architecture with clear separation between presentation, business logic, and data layers
- Express API Server with REST + JWT Auth
- Centralized error handling with consistent error response format
- Essential middleware stack: helmet, cors, compression, express.json, request-id

### Middleware Configuration

[Source: architecture.md#middleware]
Essential middleware requirements:

- **Helmet**: Security headers for protection against common vulnerabilities
- **CORS**: Cross-origin resource sharing with appropriate origins
- **Compression**: Response compression for performance optimization
- **Express.json**: Request body parsing for JSON payloads
- **Request-ID**: Request tracing for debugging and monitoring

### Error Handling Standards

[Source: architecture.md#error-handling]

- Centralized error handling middleware
- Consistent error response format across all endpoints
- Custom error classes for different error types
- Proper HTTP status codes and error messages
- Error logging with appropriate levels

### Environment Configuration

[Source: architecture.md#environment-configuration]

- Port configuration from environment variables with default fallback
- Environment-specific settings (development, production)
- Graceful shutdown handling for production deployment
- Process signal handling (SIGTERM, SIGINT)

### Performance Considerations

[Source: architecture.md#performance]

- Air-gapped environment optimizations
- Response compression for network efficiency
- Efficient middleware ordering
- Connection draining during graceful shutdown

## Testing

### Testing Framework

[Source: architecture.md#testing-strategy]
**Testing Framework**: Jest 30.0 with ESM support for API and unit testing

### Test File Location

`apps/api/src/**/*.test.ts` or `apps/api/__tests__/`

### Testing Standards

- Unit tests for utility functions and middleware
- Integration tests for API endpoints
- Supertest for HTTP endpoint testing
- Coverage thresholds to be configured in Jest setup

### Specific Requirements for this Story

- Test health endpoint response format and status codes
- Test middleware integration and error handling
- Test graceful shutdown functionality
- Test environment configuration handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-26 | 1.0 | Initial story creation from Epic 0.2 | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
