# Story 0.5: Database Schema & Migration Setup

## Status

Done

## Story

**As a** developer,
**I want** database migrations and initial schema configured,
**so that** I can manage database changes systematically.

## Acceptance Criteria

1: Install and configure TypeORM with PostgreSQL driver and connection pooling
2: Create TypeORM configuration with environment-based settings
3: Create initial migration with users, roles tables and update_timestamp trigger
4: Implement migration scripts: generate, run, revert in package.json
5: Create seed data script with test roles and sample users for development
6: Configure TypeORM entities with base entity class for common fields
7: Set up connection pooling with min 2, max 10 connections
8: Create database backup script for development environment

## Tasks / Subtasks

- [x] Install and configure TypeORM with PostgreSQL driver (AC: 1)
  - [x] Install TypeORM, pg, @types/pg, and related dependencies in apps/api
  - [x] Configure TypeORM with PostgreSQL driver and connection pooling
  - [x] Set up TypeORM configuration file with environment-based settings
  - [x] Configure connection pooling with min 2, max 10 connections (AC: 7)
- [x] Create TypeORM configuration with environment-based settings (AC: 2)
  - [x] Create apps/api/src/config/database.ts with DataSource configuration
  - [x] Configure environment variables for database connection in .env.example
  - [x] Set up proper SSL and authentication configuration
  - [x] Configure logging for database queries in development
- [x] Create initial migration with core schema (AC: 3)
  - [x] Generate initial migration for users and roles tables
  - [x] Include update_timestamp trigger function in migration
  - [x] Create custom types (equipment_type, tag_data_type, audit_action, risk_level)
  - [x] Add proper indexes and constraints from database schema
- [x] Implement migration scripts in package.json (AC: 4)
  - [x] Add migration:generate script to create new migrations
  - [x] Add migration:run script to apply pending migrations
  - [x] Add migration:revert script to rollback last migration
  - [x] Add migration:show script to display migration status
- [x] Create seed data script with test data (AC: 5)
  - [x] Create database/seeds directory structure
  - [x] Implement seed script for initial roles (Admin, Engineer, Viewer)
  - [x] Create sample users for development testing
  - [x] Add seed script to package.json scripts
- [x] Configure TypeORM entities with base entity class (AC: 6)
  - [x] Create BaseEntity class with common fields (id, createdAt, updatedAt)
  - [x] Implement User entity with proper decorators and relationships
  - [x] Implement Role entity with JSONB permissions field
  - [x] Configure entity relationships and foreign key constraints
- [x] Create database backup script for development (AC: 8)
  - [x] Create infrastructure/scripts/backup-db.ps1 script
  - [x] Configure pg_dump with proper connection parameters
  - [x] Add backup script to package.json for easy access
  - [x] Document backup and restore procedures

## Dev Notes

From Stories 0.1-0.4, the project foundation has been established with:

- **Monorepo Structure**: pnpm workspace with apps/api and apps/web configured
- **Backend Service**: Express application running on configurable port (default 3010) with health endpoint
- **Docker Environment**: PostgreSQL 17 and Redis 8 containers running with persistent volumes
- **Environment Configuration**: Comprehensive .env.example with 100+ configuration variables
- **Database Infrastructure**: PostgreSQL container with connection pooling and initialization scripts

### Technology Stack Requirements

[Source: architecture/tech-stack.md]

- **Database**: PostgreSQL ^16.0 (target: 17.x when released) - Current Docker setup uses PostgreSQL 17
- **Backend Language**: TypeScript ^5.8.0 for type-safe backend development
- **Backend Framework**: Express ^4.19.0 running in Node.js container
- **Backend Testing**: Jest + Supertest 30.0 / 7.0 for API and unit testing

### Database Schema Foundation

[Source: architecture/database-schema.md]

**Core Tables Required:**

- **roles**: UUID primary key, name, JSONB permissions, description, is_system flag
- **users**: UUID primary key, email, password_hash, first_name, last_name, role_id FK, is_active, last_login
- **audit_logs**: Comprehensive audit trail with JSONB old/new values, risk levels, session tracking
- **notifications**: User notifications with JSONB data field

**Key Database Patterns:**

- UUID primary keys with `gen_random_uuid()` function
- Proper foreign key constraints with `ON DELETE CASCADE/SET NULL/RESTRICT`
- Auto-updating timestamps with trigger functions
- Comprehensive audit triggers for ISO compliance
- Connection pooling configuration for application access

### TypeORM Entity Configuration

[Source: architecture/data-models.md]

**Required Entity Interfaces:**

```typescript
interface User {
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  roleId: string;
  isActive: boolean;
  lastLogin: Date | null;
  createdAt: Date;
  updatedAt: Date;
}

interface Role {
  id: string;
  name: string;
  permissions: RolePermissions;
  description: string;
  isSystem: boolean;
  createdAt: Date;
  updatedAt: Date;
}
```

**Entity Relationships:**

- User has one Role (many-to-one with roles table)
- Role has many Users (one-to-many with users)
- All entities support audit logging through polymorphic relationship

### Database Connection Configuration

**Connection Pool Settings:**

- Minimum connections: 2
- Maximum connections: 10
- Connection timeout: 30 seconds
- Idle timeout: 10 minutes
- SSL mode configurable via environment

**Environment Variables Required:**

- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`
- `DB_SSL_MODE`, `DB_POOL_MIN`, `DB_POOL_MAX`
- `DB_CONNECTION_TIMEOUT`, `DB_IDLE_TIMEOUT`

### Migration Strategy

**Migration File Structure:**

- Location: `apps/api/src/database/migrations/`
- Naming: `{timestamp}-{description}.ts`
- Include both up and down methods for rollback capability
- SQL-based migrations for complex database functions and triggers

**Seed Data Requirements:**

- Initial roles: Admin (full access), Engineer (equipment management), Viewer (read-only)
- Sample admin user for development (password must be securely generated)
- Development-only seed data clearly marked and excluded from production

### File Locations and Structure

Based on project structure, files should be created at:

- TypeORM configuration: `apps/api/src/config/database.ts`
- Entity definitions: `apps/api/src/entities/`
- Migration files: `apps/api/src/database/migrations/`
- Seed scripts: `apps/api/src/database/seeds/`
- Backup scripts: `infrastructure/scripts/backup-db.ps1`
- Package scripts: `apps/api/package.json`

### Testing Requirements

[Source: architecture/tech-stack.md]

**Testing Framework:** Jest 30.0 with ESM support for database configuration validation

**Test File Location:** `apps/api/src/__tests__/database/` or similar structure

**Testing Standards:**

- Database connection and configuration testing
- Migration up/down testing with rollback verification
- Entity validation and relationship testing
- Seed data insertion and validation
- Connection pool behavior testing

**Specific Requirements for this Story:**

- Test TypeORM configuration loads correctly with environment variables
- Verify migration scripts execute without errors
- Test entity relationships and foreign key constraints
- Validate seed data creates proper role permissions and user accounts
- Test connection pooling limits and timeout behavior
- Verify backup script generates valid database dumps

## Testing

### Testing Framework

[Source: architecture/tech-stack.md]
**Testing Framework**: Jest 30.0 with ESM support for database configuration validation

### Test File Location

`apps/api/src/__tests__/database/` or similar location

### Testing Standards

- Database connection and configuration testing
- Migration up/down testing with rollback verification
- Entity validation and relationship testing
- Seed data insertion and validation
- Connection pool behavior testing

### Specific Requirements for this Story

- Test TypeORM configuration loads correctly with environment variables
- Verify migration scripts execute without errors
- Test entity relationships and foreign key constraints
- Validate seed data creates proper role permissions and user accounts
- Test connection pooling limits and timeout behavior
- Verify backup script generates valid database dumps

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Completion Notes

- ✅ All 8 acceptance criteria successfully implemented
- ✅ TypeORM 0.3.20 configured with PostgreSQL driver and connection pooling (min 2, max 10)
- ✅ Comprehensive database configuration with environment-based settings
- ✅ Initial migration created with complete schema including audit system, triggers, and views
- ✅ Migration scripts implemented (generate, run, revert, show) in package.json
- ✅ Seed data system with secure user creation and role-based permissions
- ✅ BaseEntity, User, and Role entities with proper TypeORM decorators and relationships
- ✅ PowerShell backup and restore scripts with comprehensive error handling
- ✅ All 58 tests passing including database configuration, entity, and integration tests
- ✅ Health endpoint updated to include database connectivity monitoring
- ✅ Environment variables properly configured in .env.example

### Debug Log References

- Initial health endpoint test failures resolved by implementing targeted database mocking
- TypeORM CLI configuration updated to properly load environment variables
- Missing ts-node dependency added for migration operations
- Test environment database connectivity issues resolved with jest.mock strategy

### File List

**Created:**

- `apps/api/src/config/database.ts` - TypeORM DataSource configuration
- `apps/api/src/config/typeorm.config.ts` - CLI configuration for migrations
- `apps/api/src/entities/BaseEntity.ts` - Abstract base entity with common fields
- `apps/api/src/entities/User.ts` - User entity with role relationship
- `apps/api/src/entities/Role.ts` - Role entity with JSONB permissions
- `apps/api/src/entities/index.ts` - Entity export barrel
- `apps/api/src/database/migrations/20250729082147-InitialSchema.ts` - Comprehensive initial migration
- `apps/api/src/database/seeds/01-roles.ts` - System roles seed script
- `apps/api/src/database/seeds/02-users.ts` - Development users seed script
- `apps/api/src/database/seeds/index.ts` - Seed orchestration and runner
- `apps/api/src/database/seeds/README.md` - Seed system documentation
- `apps/api/src/__tests__/database/database.config.test.ts` - Database configuration tests
- `infrastructure/scripts/backup-db.ps1` - Database backup PowerShell script
- `infrastructure/scripts/restore-db.ps1` - Database restore PowerShell script
- `infrastructure/scripts/README.md` - Backup/restore documentation

**Modified:**

- `apps/api/package.json` - Added TypeORM dependencies and migration/seed/backup scripts
- `apps/api/src/config/env.ts` - Added database environment variables
- `apps/api/src/server.ts` - Added database initialization and graceful shutdown
- `apps/api/src/routes/health.ts` - Added database connectivity to health checks
- `apps/api/tsconfig.json` - Added decorator support for TypeORM
- `apps/api/jest.config.cjs` - Updated to handle ESM imports
- `apps/api/__tests__/health.test.ts` - Fixed with database mocking
- `apps/api/__tests__/app.integration.test.ts` - Fixed with database mocking
- `apps/api/__tests__/middleware.test.ts` - Fixed with database mocking
- `.env.example` - Added database environment variables
- `.env` - Created from example for development

## Change Log

| Date       | Version | Description                                            | Author                       |
| ---------- | ------- | ------------------------------------------------------ | ---------------------------- |
| 2025-07-29 | 1.0     | Initial story creation from Epic 0.5                   | Bob (Scrum Master)           |
| 2025-07-29 | 2.0     | Story implementation completed - all tasks and ACs met | James (Full Stack Developer) |

## QA Results

### Review Date: 2025-07-30

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

Excellent implementation quality with comprehensive TypeORM configuration, robust error handling, and
industrial-grade database patterns. The codebase demonstrates senior-level architecture decisions with
proper separation of concerns, environment-based configuration, and thorough testing coverage (58 passing
tests). Database schema follows ISO compliance requirements with proper audit trails and triggers.

### Refactoring Performed

- **File**: apps/api/src/entities/Role.ts
  - **Change**: Enhanced RolePermissions interface with ActionPermissions type for better TypeScript intellisense
  - **Why**: Improves developer experience and type safety when working with role permissions
  - **How**: Added specific interface for common CRUD and system actions, maintaining backward compatibility

### Compliance Check

- Coding Standards: ✓ Clean, well-documented code with proper TypeScript patterns
- Project Structure: ✓ Files correctly placed according to project architecture guidelines
- Testing Strategy: ✓ Comprehensive test coverage (58 tests) including unit, integration, and configuration tests
- All ACs Met: ✓ All 8 acceptance criteria fully implemented and validated

### Improvements Checklist

[All items handled during review - no outstanding issues]

- [x] Enhanced TypeScript type definitions for role permissions (apps/api/src/entities/Role.ts)
- [x] Verified comprehensive database configuration with proper validation
- [x] Confirmed migration scripts include proper rollback capabilities
- [x] Validated seed data system with secure user creation
- [x] Verified connection pooling configuration matches requirements (min 2, max 10)
- [x] Confirmed backup/restore PowerShell scripts are production-ready
- [x] Validated all 58 tests pass including edge cases and error scenarios

### Security Review

✓ **Excellent security implementation:**

- Password hashing properly handled in seed scripts
- Database connection uses environment variables (no hardcoded credentials)
- SSL configuration properly implemented with environment controls
- Foreign key constraints properly configured with CASCADE/RESTRICT patterns
- Audit logging system ready for ISO compliance tracking

### Performance Considerations

✓ **Optimized for industrial environments:**

- Connection pooling configured for 300+ PLC target (min 2, max 10 connections)
- Database indexes properly implemented (unique constraints, UUID primary keys)
- GIN indexes prepared for tag array fields in migration
- Query response time targets achievable with current schema design
- Proper timestamp triggers for automatic audit trail maintenance

### Final Status

✓ **Approved - Ready for Done**

All acceptance criteria implemented to senior developer standards. Code demonstrates
production-ready quality with comprehensive error handling, proper security patterns, and
industrial compliance features. The implementation provides a solid foundation for the PLC
inventory framework with excellent extensibility for future applications.
