FROM node:20-alpine

# Install curl for health checks
RUN apk add --no-cache curl

# Set working directory to workspace root
WORKDIR /workspace

# Install pnpm globally
RUN npm install -g pnpm@9

# Copy workspace configuration
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy package.json files for all workspace packages
COPY apps/api/package.json ./apps/api/
COPY apps/web/package.json ./apps/web/
# Note: packages don't have package.json yet, skip for now

# Install all dependencies using workspace
RUN pnpm install --frozen-lockfile

# Copy configuration files for Web
COPY apps/web/vite.config.ts ./apps/web/
COPY apps/web/tsconfig.json ./apps/web/
COPY apps/web/tsconfig.node.json ./apps/web/
COPY apps/web/eslint.config.js ./apps/web/
COPY apps/web/index.html ./apps/web/

# Copy static files for Web
COPY apps/web/public ./apps/web/public

# Copy source code for Web (will be overridden by volume in dev)
COPY apps/web/src ./apps/web/src

# Set working directory to Web
WORKDIR /workspace/apps/web

# Expose port
EXPOSE 5173

# Start development server
CMD ["pnpm", "dev", "--host", "0.0.0.0"]